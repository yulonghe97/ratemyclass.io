<link rel="stylesheet" href="css/sidebar.css">
<script src="/plugins/rating/jquery.star-rating-svg.js"></script>
<link rel="stylesheet" type="text/css" href="/plugins/rating/css/star-rating-svg.css">


<div class="container d-md-flex align-items-stretch mt-5">
    <!-- Page Content  -->
    <div class="container-fluid">
        <div id="content" class="pt-5">
            <div class="row d-flex">
                <div class="col col-md-12">
                    <!-- Search form -->
                    <form id="searchForm" class="form-inline d-flex md-form">
                        <input class="form-control form-control-lg ml-3 w-75" type="text" placeholder="Name/Code/Professor"
                               aria-label="Search">
                            <i class="fas fa-search" aria-hidden="true"></i>
                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-center">
                <div id="spinner" class="spinner-grow text-primary m-1 d-none" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div id="result">
                <!--Big blue-->
            <div class="row d-flex">
                <div class="col col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row d-flex">
                                <div class="col-md-10">
                                    <div class="card-title">
                                        <h5>Apply Internet Technology</h5>
                                    </div>
                                    <div class="card-subtitle pt-2 pb-2 font-small text-muted">
                                        <a>CSCI-UA-480</a>
                                        <a class="ml-2 mr-2">|</a>
                                        <a>Joe Versoza</a>
                                    </div>
                                    <div class="card-text">
                                        <ul class="list-unstyled list-group list-group-horizontal">
                                            <li class="mr-3 dark-grey-text">Quality &nbsp;<i class="rating-1"></i>&nbsp;</li>
                                            <li class="mr-3 dark-grey-text">Difficulty &nbsp;<i class="rating-2"></i>&nbsp;</li>
                                            <li class="mr-3 dark-grey-text">Avg. Grade: <span class="badge badge-pill badge-danger">A</span></li></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-2 d-inline-block align-middle">
                                    <div class="card-text text-right">
                                        <p>
                                            <a class="ml-3 text-danger"><i class="fas fa-fire"></i></a>
                                            <small class="text-muted">2</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    <nav class="ml-3" id="sidebar">
        <div class="p-4 pt-5 mt-2">
            <div class="form-group">
                <!-- Material input -->
                <div class="row">
                    <div class="col-md-12 select-outline">
                        <select class="mdb-select md-form md-outline colorful-select dropdown-primary">
                            <option value="relevance" >Relevance</option>
                            <option value="quality">Quality</option>
                            <option value="difficulty">Difficulty</option>
                            <option value="grade">Grade</option>
                        </select>
                        <label>Sort By</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 select-outline">
                        <select class="mdb-select md-form md-outline colorful-select dropdown-primary">
                            <option value="New York University" >NYU</option>
                        </select>
                        <label>School</label>
                    </div>
                </div>
            </div>
            <div class="mb-5">
                <h5 class="text-dark p-2">Tags</h5>
                <div class="tagcloud">
                    <a href="#" class="tag-cloud-link">dish</a>
                    <a href="#" class="tag-cloud-link">menu</a>
                    <a href="#" class="tag-cloud-link">food</a>
                    <a href="#" class="tag-cloud-link">sweet</a>
                    <a href="#" class="tag-cloud-link">tasty</a>
                    <a href="#" class="tag-cloud-link">delicious</a>
                    <a href="#" class="tag-cloud-link">desserts</a>
                    <a href="#" class="tag-cloud-link">drinks</a>
                </div>
            </div>
        </div>
    </nav>

</div>

<script>

    // Material Select Initialization
    $(document).ready(function() {
        $('.mdb-select').materialSelect();
        $('.select-wrapper.md-form.md-outline input.select-dropdown').bind('focus blur', function () {
            $(this).closest('.select-outline').find('label').toggleClass('active');
            $(this).closest('.select-outline').find('.caret').toggleClass('active');
        });
    });

    // nav
    $("#classBtn").addClass('active');
    $(".rating-1").starRating({
        useFullStars: true,
        starShape: 'rounded',
        starSize: 20
    });
    $('.rating-1').starRating('setRating', 2.5);
    $('.rating-1').starRating('setReadOnly', true);
    $(".rating-2").starRating({
        useFullStars: true,
        starShape: 'rounded',
        starSize: 20
    });
    $('.rating-2').starRating('setRating', 5);
    $('.rating-2').starRating('setReadOnly', true);

    // API FETCH

    function addResult(currentClass,num){
        const result = `<div class="row d-flex">
                <div class="col col-md-12 mt-2">
                    <div class="card animated fadeInUp hoverable">
                        <div class="card-body">
                            <div class="row d-flex">
                                <div class="col-md-10">
                                    <div class="card-title">
                                        <h5>${currentClass.className}</h5>
                                    </div>
                                    <div class="card-subtitle pt-2 pb-2 font-small text-muted">
                                        <a>${currentClass.classCode}</a>
                                        <a class="ml-2 mr-2">|</a>
                                        <a>${currentClass.professor}</a>
                                    </div>
                                    <div class="card-text">
                                        <ul class="list-unstyled list-group list-group-horizontal">
                                            <li class="mr-3 dark-grey-text">Quality &nbsp;<i class="rating-quality-${num}"></i>&nbsp;</li>
                                            <li class="mr-3 dark-grey-text">Difficulty &nbsp;<i class="rating-difficulty-${num}"></i>&nbsp;</li>
                                            <li class="mr-3 dark-grey-text">Avg. Grade: <span class="badge badge-pill badge-danger">${currentClass.overallGradeLetter}</span></li></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-2 d-inline-block align-middle">
                                    <div class="card-text text-right">
                                        <p>
                                        <a class="ml-3 text-danger"><i class="fas fa-fire"></i></a>
                                        <small class="text-muted">${currentClass.reviews.length}</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <a href="/class/${currentClass._id}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>`;

        // Calculate Half Rates
        let classQualityRate, classDifficultyRate;
        classQualityRate = currentClass.overallClassQualityRate;
        classDifficultyRate = currentClass.overallClassDifficultyRate;
        const QualityRateDec = classQualityRate - Math.floor(classQualityRate);
        const DifficultyRateDec = classDifficultyRate - Math.floor(classDifficultyRate);
        if(QualityRateDec >= 0.35 && QualityRateDec < 0.50){
            classQualityRate = Math.floor(classQualityRate) + 0.50;
        } else if(QualityRateDec >= 0.50 && QualityRateDec < 0.75){
            classQualityRate = Math.floor(classQualityRate) + 0.50;
        }else if(QualityRateDec >= 0.75){
            classQualityRate = Math.ceil(classQualityRate);
        }
        if(DifficultyRateDec >= 0.35 && DifficultyRateDec < 0.50){
            classDifficultyRate = Math.floor(classDifficultyRate) + 0.50;
        } else if(DifficultyRateDec >= 0.50 && DifficultyRateDec < 0.75){
            classDifficultyRate = Math.floor(classDifficultyRate) + 0.50;
        }else if(DifficultyRateDec >= 0.75){
            classDifficultyRate = Math.ceil(classDifficultyRate);
        }

        $("#result").append(result);

        $(`.rating-quality-${num}`).starRating({
            useFullStars: false,
            starShape: 'rounded',
            starSize: 20,
            forceRoundUp:true
        });
        $(`.rating-difficulty-${num}`).starRating({
            useFullStars: false,
            starShape: 'rounded',
            starSize: 20,
            forceRoundUp:true
        });
        $(`.rating-quality-${num}`).starRating('setRating', classQualityRate);
        $(`.rating-difficulty-${num}`).starRating('setRating', classDifficultyRate);
        $(`.rating-quality-${num}`).starRating('setReadOnly', true);
        $(`.rating-difficulty-${num}`).starRating('setReadOnly', true);

    }

    $("#searchForm").keyup(function (event) {

        $("#result").empty();
        $("#spinner").removeClass('d-none');
        $.getJSON(`/api/searchClass/${event.target.value}`, function (data) {
            for(let i=0; i<data.length;i++){
                addResult(data[i],i);
            }
            setTimeout(function () {
                $("#spinner").addClass('d-none');
            },800);
        });
    });


</script>